buildscript {
	ext {
		springBootVersion = '2.0.1.RELEASE'
	}
	repositories {
		mavenCentral()
        jcenter()
        maven {
		url "https://plugins.gradle.org/m2/"
        }
	}
	dependencies {
		classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
		classpath("me.champeau.gradle:jmh-gradle-plugin:0.4.7")
	}
}

plugins {
	id 'com.google.cloud.tools.jib' version '1.0.2'
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'
apply plugin: 'war'

apply plugin: 'me.champeau.gradle.jmh'

group = 'com.joshcummings'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = 1.8

repositories {
	mavenCentral()
}

jib {
	from.image = 'tomcat:8.5-jre8-alpine'
	to.image = 'terracotta-bank'
	container.appRoot = '/usr/local/tomcat/webapps/ROOT'
	container.environment = [JAVA_OPTS : '-Xmx512m -Djdk.xml.entityExpansionLimit=0']
}

test {
	useTestNG()
}

jmh {
	includeTests = true
	duplicateClassesStrategy = 'warn'
}

project.configurations {
	vulnerabilityTestCompile {
		extendsFrom testCompile
	}
	vulnerabilityTestRuntime {
		extendsFrom vulnerabilityTestCompile, testRuntime
	}
}

project.sourceSets {
	vulnerabilityTest {
		java.srcDir project.file('src/vulnerability-test/java')
		resources.srcDir project.file('src/vulnerability-test/resources')
		compileClasspath = project.sourceSets.main.output +
				project.sourceSets.test.output +
				project.configurations.vulnerabilityTestCompile
		runtimeClasspath = output + compileClasspath + project.configurations.vulnerabilityTestRuntime
	}
}

Task vulnerabilityTestTask = project.tasks.create("vulnerabilityTest", Test) {
	useTestNG()
	group = 'Verification'
	description = 'Runs vulnerability tests'
	dependsOn 'jar'
	testClassesDirs = project.sourceSets.vulnerabilityTest.output.classesDirs
	classpath = project.sourceSets.vulnerabilityTest.runtimeClasspath
}

idea {
	module {
		testSourceDirs += project.sourceSets.jmh.java.srcDirs
		testSourceDirs += project.sourceSets.vulnerabilityTest.java.srcDirs
	}
}

dependencies {
	compile('org.springframework.boot:spring-boot-starter-data-jpa')
	//compile('org.springframework.boot:spring-boot-starter-security')
	compile('org.springframework.boot:spring-boot-starter-web')

	compile('org.hsqldb:hsqldb')
	compile('javax.mail:mail:1.4')
	compile('javax.servlet:jstl')
	compile('org.apache.tomcat.embed:tomcat-embed-jasper')

	compile('javax.xml.bind:jaxb-api')
	compile('com.sun.xml.bind:jaxb-core:2.3.0.1')
	compile('com.sun.xml.bind:jaxb-impl:2.3.0.1')
	
	testCompile('org.springframework:spring-beans')
	testCompile('org.springframework:spring-context')
	testCompile('org.springframework:spring-core')
	testCompile('org.springframework.boot:spring-boot-starter-test')
	testCompile('org.springframework.security:spring-security-test')

	testCompile('com.github.docker-java:docker-java:3.0.14')
	testCompile('com.github.mike10004:littleproxy:1.1.3socksmod1')
	testCompile('io.github.bonigarcia:webdrivermanager:2.2.1')
 	testCompile('org.mockito:mockito-core')
	testCompile('org.seleniumhq.selenium:selenium-java')
	testCompile('org.testng:testng:6.14.3')

	jmh('org.openjdk.jmh:jmh-core:1.21')
	jmh('org.openjdk.jmh:jmh-generator-annprocess:1.21')
	jmh('org.apache.httpcomponents:httpclient:4.5')
}
